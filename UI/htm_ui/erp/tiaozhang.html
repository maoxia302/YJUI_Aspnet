<style>
    .tiaozhang_cont {
        padding: 10px;
    }
     
    .tiaozhang_form td {
        padding: 2px 20px 2px 0;
    }
    .tiaozhang_form td > input,.tiaozhang_form td  textarea {
        display: inline-block;
        width: 138px;
        padding: 6px 5px;
        margin-left: 5px;
        border: 1px solid #95B8E7;
        background-color: #fff;
        border-radius: 4px;
        -webkit-border-radius: 4px;
    }
    .tiaozhang_form td > input.Wdate{
        padding:3px 5px;
    }
    .tiaozhang_form td > input[type="checkbox"] {
        width: 15px;
        height: 15px;
        vertical-align: middle;
    }
    .tiaozhang_form td  textarea {
        vertical-align:top;
        resize:none;
    }
    .tiaozhang_form td > .combo {
        border-radius: 4px;
        -webkit-border-radius: 4px;
        margin-left: 5px;
    }
    .dgBar {
        clear:both;
    }
    .dgBar .tiaozhang_form td{
        padding:2px;
    }
    .dgBar:after{display:block;clear:both;height:0;visibility:hidden;content:" "}
    .dbCont {
        padding:0 10px;
    }
    .dbCont > p .combo{
        border-radius: 4px;
        -webkit-border-radius: 4px;
    }
    .dbCont > p > input {
        display: inline-block;
        width: 130px;
        padding: 6px 5px;
        margin-left: 5px;
        margin-right: 4px;
        border: 1px solid #95B8E7;
        background-color: #fff;
        border-radius: 4px;
        -webkit-border-radius: 4px;
    }
    .buttonNew {
        display: inline-block;
        padding: 2px 8px;
        color: #444;
        background: #fafafa;
        background-repeat: repeat-x;
        border: 1px solid #bbb;
        background-color: #eaf2ff;
        -moz-border-radius: 5px 5px 5px 5px;
        -webkit-border-radius: 5px 5px 5px 5px;
        border-radius: 5px 5px 5px 5px;
        border: 1px solid #b7d2ff;
    }
    .buttonNew:hover {
        color:#000;
        text-decoration:none;
        opacity:0.8;
    }
    .isPass {
        position: relative;
    }
    .isPass > i.pass, .isPass > i.noPass {
        position: absolute;
        top: -10px;
        left: -65px;
        width: 90px;
        display: none;
    }
    .isPass > i.pass > img, .isPass > i.noPass > img {
        display: block;
        width: 100%;
    }
    .isPass > i.pass {
        display: block;
    }
    .dgCont .datagrid-header-row, .dgCont .datagrid-row {
        height: 36px;
    }
    .dgCont .datagrid-editable-input {
        height: 30px;
    }
    .combo {
        height: 34px;
    }
    
</style>
<script src="../../javascript/jquery.form.min.js"></script>
<div class="tiaozhang_cont">
    <!--tabs切换内容开始-->
    <div class="easyui-tabs">
        <div title="详细字段" style="padding:10px">
            <table class="tiaozhang_form">
                <tr>
                    <td>&ensp;&ensp;&emsp;单别:<input type="text" class="easyui-combogrid" id="orderType" style="height:28px;" /><a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-dbtype'" id="panchun" onclick="orderTypeQty()">选择</a></td>
                    <td>部门编号:<input type="text" class="easyui-combogrid" id="dep" style="height:28px;"  /><a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-org'" id="depname" onclick="depmentQty()">选择</a></td>
                    <td>人员编号:<input type="text" class="easyui-combogrid" id="emp" style="height:28px;" /><a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-user'" id="empname" onclick="empQty()">选择</a></td>
                    <td><input type="checkbox" id="creatEntry" />生成分录</td>
                </tr>
                <tr>
                    <td>&ensp;&ensp;&emsp;单号:<input type="text"  id="danhao"/></td>
                    <td>&ensp;&ensp;&emsp;工厂:<input type="text" class="easyui-combogrid" id="gongchang" /><a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-cangku'">选择</a></td>
                    <td>交易日期:<input type="text" class="Wdate" id="jyDate" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})" autocomplete="off"/></td>
                    <td class="isPass">
                        <i class="pass"><img src="../../images/icon_pass.png" alt="" /></i>
                        <i class="noPass"><img src="../../images/icon_noPass.png" alt="" /></i>
                    </td>
                </tr>
                <tr>
                    <td>单据日期:<input type="text" class="Wdate" id="djDate" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',onpicking: function (dp) {if (dp.cal.getDateStr() != dp.cal.getNewDateStr()) { Func(dp.cal.getNewDateStr())}}})" autocomplete="off" /></td>
                    <td>&ensp;&ensp;&emsp;件数:<input type="text" id="jianshu" /></td>
                </tr>
                <tr>
                    <td>&ensp;&ensp;&emsp;备注:<textarea id="beizhu" style="height:50px;"></textarea></td>
                    <td>项目编号:<input type="text" id="proId" /></td>
                </tr>
            </table>
        </div>
        <div title="其他信息" style="padding:10px">
            <table class="tiaozhang_form">
                <tr>
                    <td>业务人员:<input type="text" /></td>
                    <td>部门编号:<input type="text" /></td>
                </tr>
            </table>
        </div>
    </div>
    <!--tabs切换内容结束-->
    <!--table内容开始-->
    <div>
        <div id="dgToolbar" class="dgBar" style="padding:6px 10px;background-color:#F4F4F4;border:1px solid #95B8E7;border-bottom:none;clear:both">
            <table class="tiaozhang_form" style="float:left;">
                <tr>
                    <td>品号:<input class="text" /></td>
                    <td><a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="proQty()" style="margin-left:10px">搜索</a></td>
                    <td><a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'" onclick="addTr()">添加一行</a></td>
                </tr>
            </table>
            <table class="tiaozhang_form" style="float:right;">
                <tr>
                    <td>修改字段:<input id="modifyType" class="easyui-combobox" style="height:30px;" /></td>
                    <td>修改内容:<input type="text" id="modifyTxt" /></td>
                    <td><a href="javascript:void(0)" class="easyui-linkbutton" onclick="batchModify()">批量修改</a></td>
                    <td><a href="javascript:void(0)" class="easyui-linkbutton" onclick="batchImp()">批量导入</a></td>
                </tr>
            </table>
        </div>
        <div class="easyui-layout dgCont" data-options="fit : true,border : false" style="height:320px;">
            <div data-options="region:'center',border:false">
                <table id="dg"></table>
            </div>
        </div>
        
        
        <div id="idToolbar" style="padding:10px;display: none;">
            品号:
            <input class="easyui-textbox" style="width:200px" />
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="toSearch()" style="margin-left:10px">搜索</a>
        </div>
    </div>
    <!--table内容结束-->
    

    <div id="batchTr">
        <div class="easyui-layout" style="margin:10px;height:300px">
            <table id="proList"></table>
        </div>
    </div>

    <!--单别弹层内容开始-->
    <div id="dbWin">
        <div class="dbCont">
            <p>
                单别：
                <input class="easyui-combobox" id="dbCombox" style="height:28px;" />
                <input type="text" />
                <a href="#" class="buttonNew" style="padding:5px 8px;">重新查找</a>
            </p>
            <div data-options="region:'center',border:false" style="width:100%;height:260px;overflow-y:auto">
                <table id="dbList"></table>
            </div>
            <!--单别弹层内容结束-->
        </div>
    </div>
</div>
    <script type="text/javascript">

        var today = new Date();
        var y = today.getFullYear();
        var m = today.getMonth() + 1;
        var d = today.getDate();
        m = m < 10 ? "0" + m : m;
        d = d < 10 ? "0" + d : d;
        $("#djDate").val(y + "-" + m + "-" + d);
        $("#jyDate").val(y + "-" + m + "-" + d);

        function Func(tim) {
            console.log(tim)//将选好的时间携带过来
            //console.log($("#orderType").combogrid('getValue'))
            GetOrderId($("#orderType").combogrid('getValue'),tim);
        }

        function GetOrderId(orderId,tim) {
            var data = {
                "orderId": orderId,
                "tim": tim
            };
            $.ajax({
                //url: "ashx_ui/login.ashx",
                url: "ashx_ui/INVTA.ashx?action=searchErpNum",
                type: "POST",
                data: data,
                success: function (result) {
                    $("#danhao").val(result);
                }
            });

        }

        //批量导入插件----开始
        var excelData = [];//导入excel转json数据
		/*
    FileReader共有4种读取方法：
    1.readAsArrayBuffer(file)：将文件读取为ArrayBuffer。
    2.readAsBinaryString(file)：将文件读取为二进制字符串
    3.readAsDataURL(file)：将文件读取为Data URL
    4.readAsText(file, [encoding])：将文件读取为文本，encoding缺省值为'UTF-8'
                 */
        var wb;//读取完成的数据
        var rABS = false; //是否将文件读取为二进制字符串

        function importf(obj) {//导入
            if (!obj.files) {
                return;
            }
            var f = obj.files[0];
            $("#fileName").val(f.name);
            var reader = new FileReader();
            reader.onload = function (e) {
                var data = e.target.result;

                if (rABS) {
                    wb = XLSX.read(btoa(fixdata(data)), {//手动转化
                        type: 'base64'
                    });
                } else {
                    wb = XLSX.read(data, {
                        type: 'binary'
                    });
                }
                //wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
                //wb.Sheets[Sheet名]获取第一个Sheet的数据
                //document.getElementById("demo").innerHTML= JSON.stringify( XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]) );
                excelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

            };
            if (rABS) {
                reader.readAsArrayBuffer(f);
            } else {
                reader.readAsBinaryString(f);
            }
        }

        function fixdata(data) { //文件流转BinaryString
            var o = "",
                l = 0,
                w = 10240;
            for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
            o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
            return o;
        }
        var editRow;
        $(function () {
            var modifyArr = [
                { 'id': 'qty', 'text': '数量' },
                { 'id': 'price', 'text': '单价' },
            ];
            $('#modifyType').combobox({
                data: modifyArr,
                valueField: 'id',
                textField: 'text',

            });
            //datagrid加载
            var batchData = {
                rows: [
                   // { sortId: '0001', id: '', mb001: '活塞环', mb002: '474/强化', 数量: '2', price: '23.00', money: '89' },
                ],
                footer: [{ sortId: '总计', 数量: '' }]
            };
            var products = [
                { id: 'FI-SW-01', mb001: 'Koi', mb002: 'a', qty: '1', price: '1.0', money: '34.0' },
                { id: 'FI-SW-02', mb001: 'Dalmation', mb002: 'b', qty: '2', price: '2.6', money: '67.0' },
                { id: 'FI-SW-03', mb001: 'Rattlesnake', mb002: 'c', qty: '3', price: '3.9', money: '34.0' },
                { id: 'FI-SW-04', mb001: 'Iguana', mb002: 'd', qty: '4', price: '4.9', money: '78.0' },
                { id: 'FI-SW-05', mb001: 'Manx', mb002: 'e', qty: '5', price: '5.7', money: '34.0' },
                { id: 'FI-SW-06', mb001: 'Persian', mb002: 'f', qty: '6', price: '6.6', money: '28.0' },
                { id: 'FI-SW-07', mb001: 'Amazon Parrot', mb002: 'g', qty: '7', price: '6.6', money: '97.0' }
            ];
            

            $('#dg').datagrid({
                striped: false, nowrap: false, fitColumns: true, autoRowHeight: false, rownumbers: false, singleSelect: false,
                showFooter: true, remoteSort: false, sortable: "true", fit: true,
                toolbar: dgToolbar,
                columns: [[
                    { field: 'ck', checkbox: true },
                    { field: 'sortId', title: '序号', halign: 'center', align: 'center', width: 20 },
                    {
                        field: '品号', title: '品号', halign: 'center', align: 'center', width: 30,
                        editor: {
                            type: 'combogrid',
                            options: {
                                panelWidth: 550,
                                idField: 'id',
                                textField: 'id',
                                required: false,
                                editable: true,
                                toolbar: idToolbar,
                                columns: [[
                                    { field: 'id', title: '品号', width: 130 },
                                    { field: 'mb001', title: '品名', width: 100 },
                                    { field: 'mb002', title: '规格', width: 120 },
                                    { field: 'qty', title: '数量', width: 100 },
                                    { field: 'price', title: '单价', width: 100 },
                                    { field: 'money', title: '金额', width: 100 }
                                ]],
                                data: products,
                                //required:true,
                                onSelect: function (index, row) {
                                    /*var dgId = $('#dg').datagrid('getEditor', { index: editRow, field: 'id' });
                                    console.log("zzzzzzzzzzz");
                                    console.log(editRow)
                                    console.log(dgId)
                                    //if (!isEmpty(dgId)) {
                                        $(dgId.target).val(row.id); //赋值
                                        var mb001 = $('#dg').datagrid('getEditor', { index: editRow, field: 'mb001' });
                                        $(mb001.target).val(row.mb001); //赋值

                                    //}*/
                                    
                                },
                                //events: {
                                //    keyup: function (e) {
                                //        if (e.keyCode == 13) {
                                //            //enter键
                                //            var ed = $('#dg').datagrid('getEditor', { index: editRow, field: 'mb001' });
                                //            $(ed.target).next().children().focus();
                                //        }

                                //    }
                                //}
                            }
                        }
                    },
                    {
                        field: '品名', title: '品名', halign: 'center', align: 'center', width: 50,
                        //editor: {
                        //    type: 'text',
                        //    options: {
                        //        //events: {
                        //        //    keyup: function (e) {
                        //        //        if (e.keyCode == 13) {
                        //        //            //点击enter健
                        //        //            var ed = $('#dg').datagrid('getEditor', { index: editRow, field: 'mb002' });
                        //        //            $(ed.target).next().children().focus();
                        //        //        } else if (e.keyCode == 38) {
                        //        //            //点击上箭头
                        //        //            if (editRow > 0) {
                        //        //                $("#dg").datagrid("endEdit", editRow);
                        //        //                editRow = editRow - 1;
                        //        //                $("#dg").datagrid("beginEdit", editRow);
                        //        //                var ed = $('#dg').datagrid('getEditor', { index: editRow, field: 'mb001' });
                        //        //                $(ed.target).next().children().focus();
                        //        //            }

                        //        //        } else if (e.keyCode == 40) {
                        //        //            //点击下箭头
                        //        //            var data = $('#dg').datagrid('getData');
                        //        //            if (editRow < data.rows.length - 1) {
                        //        //                $("#dg").datagrid("endEdit", editRow);
                        //        //                editRow = editRow + 1;
                        //        //                $("#dg").datagrid("beginEdit", editRow);
                        //        //                var ed = $('#dg').datagrid('getEditor', { index: editRow, field: 'mb001' });
                        //        //                $(ed.target).next().children().focus();
                        //        //            }

                        //        //        }

                        //           // }
                        //        //}
                        //    }
                        //},
                    },
                    {
                        field: '规格', title: '规格', halign: 'center', align: 'center', width: 50,
                        //editor: {
                        //    type: 'text',
                        //    //options: {
                        //    //    events: {
                        //    //        keyup: function (e) {
                        //    //            if (e.keyCode == 13) {
                        //    //                var ed = $('#dg').datagrid('getEditor', { index: editRow, field: 'qty' });
                        //    //                $(ed.target).next().children().focus();
                        //    //            }

                        //    //        }
                        //    //    }
                        //    //}
                       // },
                    },
                    { field: '数量', title: '数量', halign: 'center', align: 'center', width: 20, editor: { type: 'text' }, },
                    {
                        field: '仓库编码', title: '仓库编码', halign: 'center', align: 'center', width: 50, editor: { type: 'text' },
                        editor: {
                            type: 'combogrid',
                            options: {
                                panelWidth: 550,
                                idField: 'id',
                                textField: 'id',
                                required: false,
                                editable: true,
                                toolbar: idToolbar,
                                columns: [[
                                    { field: 'id', title: '品号', width: 130 },
                                    { field: 'mb001', title: '品名', width: 100 },
                                    { field: 'mb002', title: '规格', width: 120 },
                                    { field: 'qty', title: '数量', width: 100 },
                                    { field: 'price', title: '单价', width: 100 },
                                    { field: 'money', title: '金额', width: 100 }
                                ]],
                                data: products,
                                //required:true,
                                onSelect: function (index, row) {
                                    /*var dgId = $('#dg').datagrid('getEditor', { index: editRow, field: 'id' });
                                    console.log("zzzzzzzzzzz");
                                    console.log(editRow)
                                    console.log(dgId)
                                    //if (!isEmpty(dgId)) {
                                        $(dgId.target).val(row.id); //赋值
                                        var mb001 = $('#dg').datagrid('getEditor', { index: editRow, field: 'mb001' });
                                        $(mb001.target).val(row.mb001); //赋值

                                    //}*/

                                },
                                //events: {
                                //    keyup: function (e) {
                                //        if (e.keyCode == 13) {
                                //            //enter键
                                //            var ed = $('#dg').datagrid('getEditor', { index: editRow, field: 'mb001' });
                                //            $(ed.target).next().children().focus();
                                //        }

                                //    }
                                //}
                            }
                        }
                    },
                    { field: '仓库名称', title: '仓库名称', halign: 'center', align: 'center', width: 50, editor: { type: 'text' }, },
                    {
                        field: 'button', title: '操作', halign: 'center', align: 'center', width: 40,
                        formatter: function (value, row, index) {
                            if (row.sortId == '总计') {
                                return '';
                            } else {
                                return '<a href="#" class="buttonNew" onclick="delet(' + index + ')">删除</a>';
                            }

                        }
                    },
                ]],
               data: batchData,
                onClickCell: function (rowIndex, field, value) {
                    var idAttr = this.getAttribute("id");
                    var row = $("#" + idAttr).datagrid('getData').rows[rowIndex];
                    if (editRow != undefined) {
                        $("#" + idAttr).datagrid("endEdit", editRow);
                    }
                    $("#" + idAttr).datagrid("beginEdit", rowIndex);
                    editRow = rowIndex;
                    focusNext(editRow);


                },
                onAfterEdit: function (rowIndex, rowData, changes) {
                    CalcFooter();//刷新footer
                }
            });

            CalcFooter();//刷新footer

            $("#orderType").combogrid({
                panelWidth: 500,
                idField: 'MQ001',
                textField: 'MQ001',
                //data:orderData,
                url:"../ashx_ui/CMSMQ.ashx?action=search",
                columns: [[
                    { field: 'MQ001', title: '单别', width: 80 },
                    { field: 'MQ002', title: '单据名称', width: 120 }
                    
                ]],
                fitColumns: true,
                onSelect: function (rec,row) {
                    $("#panchun").find(".l-btn-text").text(row.MQ002);
                },
                onChange: function (newValue, oldValue) {
                    GetOrderId(newValue, $("#djDate").val()); 
                }
            });

            //部门

            $("#dep").combogrid({
                panelWidth: 500,
                idField: 'ME001',
                textField: 'ME001',
                //data:orderData,
                url: "../ashx_ui/CMSME.ashx?action=search",
                columns: [[
                    { field: 'ME001', title: '单别', width: 80 },
                    { field: 'ME002', title: '单据名称', width: 120 }

                ]],
                fitColumns: true,
                onSelect: function (rec, row) {
                    $("#depname").find(".l-btn-text").text(row.ME002);
                },
                onChange: function (newValue, oldValue) {
                    // GetOrderId(newValue, $("#djDate").val());
                }
            });


            //单别弹层
            var modifyArr = [
                { 'id': 'MQ001', 'text': '单别' },
                { 'id': 'MQ002', 'text': '单据名称' },
            ];
            $('#dbCombox').combobox({
                data: modifyArr,
                valueField: 'id',
                textField: 'text',
            });
            $("#dbList").datagrid({
                striped: false, nowrap: false, fitColumns: true, autoRowHeight: false, rownumbers: true, singleSelect: true,
                showFooter: false, remoteSort: false, sortable: "true", fit: true,
                toolbar: dgToolbar,
                columns: [[
                    { field: 'MQ001', title: '单别', halign: 'center', align: 'center', width: 50 },
                    { field: 'MQ002', title: '单别名称', halign: 'center', align: 'center', width: 50 }
                ]],
                url: "../ashx_ui/CMSMQ.ashx?action=search",
                onClickCell: function (rowIndex, field, value) {
                    var idAttr = this.getAttribute("id");
                    var row = $("#" + idAttr).datagrid('getData').rows[rowIndex];
                    $('#orderType').combogrid('setValue', row.MQ001);
                    $("#panchun").find(".l-btn-text").text(row.MQ002);
                    $("#dbWin").dialog('close');
                },
            });
        });

        function CalcFooter() {
            var rs = $('#dg').datagrid('getRows');
            var qtyTotal = 0;
            for (var i = 0; i < rs.length; i++) {
                if (!isEmpty(rs[i]['数量'])) {
                    qtyTotal += parseFloat(rs[i]['数量']);
                }
            }
            var fs = $('#dg').datagrid('getFooterRows');
            fs[0].数量 = qtyTotal;
            $('#dg').datagrid('reloadFooter', fs);
        }

        //点击品号列弹层
        $("#batchTr").dialog({
            title: '选择产品',
            width: 600,
            height: 400,

            buttons: [
                {
                    text: '取消',
                    iconCls: 'icon-cancel',
                    handler: function () {
                        $("#batchTr").dialog('close');
                    }
                }, {
                    text: '确认',
                    iconCls: 'icon-ok',
                    handler: function () {
                        var ckData = $("#proList").datagrid('getChecked');

                        var lastId = 0;
                        var rows = $('#dg').datagrid("getRows");
                        if (rows.length > 0) {
                            lastId = $('#dg').datagrid('getData').rows[rows.length - 1].sortId;
                        }
                        for (var i = 0; i < ckData.length; i++) {
                            var rows = $('#dg').datagrid("getRows");
                            var sortIndex = parseInt(lastId) + i + 1;
                            ckData[i].sortId = PrefixInteger(sortIndex, 4);

                            $("#dg").datagrid("insertRow", { index: rows.length, row: ckData[i] });
                        }
                        CalcFooter();//刷新footer
                        $("#batchTr").dialog('close');
                    }
                }
            ]
        });

        $("#batchTr").dialog('close');

        //toolbar录入品号，点击“搜索”
        function proQty() {
            proLoad();
        }

        //品号查询弹层内容加载
        function proLoad() {
            $("#batchTr").dialog('open');
            var proData = [
                { 'id': '1235534', 'mb001': '活塞环1', 'mb002': '345/强化', 'qty': '2', 'price': '23.00' },
                { 'id': '3143014', 'mb001': '活塞环2', 'mb002': '474/强化', 'qty': '5', 'price': '45.00' },
                { 'id': '3407826', 'mb001': '活塞环3', 'mb002': '768/强化', 'qty': '3', 'price': '26.00' },
                { 'id': '4572737', 'mb001': '活塞环4', 'mb002': '127/强化', 'qty': '9', 'price': '28.00' },
                { 'id': '6701918', 'mb001': '活塞环5', 'mb002': '474/强化', 'qty': '2', 'price': '35.00' }
            ];
            $("#proList").datagrid({
                striped: false, nowrap: false, fitColumns: true, autoRowHeight: false, rownumbers: true, singleSelect: false,
                showFooter: false, remoteSort: false, sortable: "true", fit: true,

                columns: [[
                    { field: 'ck', checkbox: true },
                    { field: 'id', title: '品号', halign: 'center', align: 'center', width: 50 },
                    { field: 'mb001', title: '品名', halign: 'center', align: 'center', width: 50 },
                    { field: 'mb002', title: '规格', halign: 'center', align: 'center', width: 50 },
                    { field: 'qty', title: '数量', halign: 'center', align: 'center', width: 50 },
                    { field: 'price', title: '单价', halign: 'center', align: 'center', width: 50 },
                    { field: 'money', title: '金额', halign: 'center', align: 'center', width: 50 },
                ]],
                data: proData,
            });
        }

        //获取table最后一行序号
        function getSortId(elId) {
            var rows = $(elId).datagrid("getRows");
            var sortIndex = 1;
            if (rows.length > 0) {
                var lastId = $(elId).datagrid('getData').rows[rows.length - 1].sortId;
                sortIndex = parseInt(lastId) + 1;
            }
            return PrefixInteger(sortIndex, 4);
        }

        //添加行
        function addTr() {

            //if (!headerCheck()) {
            //    return false;
            //}
            var rows = $('#dg').datagrid("getRows");
            $("#dg").datagrid("insertRow", { index: rows.length, row: { 'sortId': getSortId('#dg'), 'id': '', 'mb001': '', 'mb002': '', 'qty': '', 'price': '' } });
            if (editRow != undefined) {
                $("#dg").datagrid("endEdit", editRow);
            }
            $("#dg").datagrid("beginEdit", rows.length - 1);
            editRow = rows.length - 1;
            focusNext(editRow);
        }

        //校验header内容
        function headerCheck() {
            var orderTypeTxt = $("#orderType").combogrid('getValue');//单别
            var depTxt = $("#dep").combogrid('getValue');//部门
            var empTxt = $("#emp").combogrid('getValue');//人员编号
            var creatEntyTxt = $("#creatEntry").is(":checked");//生成分录
            //单号
            var danhaoTxt = $("#danhao").val();
            //工厂
            var gcTxt = $("#gongchang").combogrid('getValue');
            //交易日期
            var jyDateTxt = $("#jyDate").val();
            //单据日期
            var djDateTxt = $("#djDate").val();
            //件数
            var jianshuTxt = $("#jianshu").val();
            //备注
            var bezhuTxt = $("#beizhu").val();
            //项目编号
            var proIdTxt = $("#proId").val();
            if (isEmpty(orderTypeTxt)) {
                //判断单别为空
                $.show_warning("提示", "单别为空");
                return false;
            } else if (isEmpty(depTxt)) {
                //判断部门为空
                $.show_warning("提示", "部门为空");
                return false;
            } else if (isEmpty(empTxt)) {
                //判断人员编号为空
                $.show_warning("提示", "人员编号为空");
                return false;
            }
            //else if (!creatEntyTxt) {
            //    //判断生成分录未勾选
            //    $.show_warning("提示", "生成分录未勾选");
            //    return false;
            //}
            else if (isEmpty(danhaoTxt)) {
                //判断单号为空
                $.show_warning("提示", "单号为空");
                return false;
            } else if (isEmpty(gcTxt)) {
                //判断工厂为空
                $.show_warning("提示", "工厂为空");
                return false;
            } else if (isEmpty(jyDateTxt)) {
                //判断交易日期为空
                $.show_warning("提示", "交易日期为空");
                return false;
            } else if (isEmpty(djDateTxt)) {
                //判断单据日期为空
                $.show_warning("提示", "单据日期为空");
                return false;
            }
            //else if (isEmpty(jianshuTxt)) {
            //    //判断件数为空
            //    $.show_warning("提示", "件数为空");
            //    return false;
            //}
            else if (isEmpty(bezhuTxt)) {
                //判断备注为空
                $.show_warning("提示", "备注为空");
                return false;
            }
            //else if (isEmpty(proIdTxt)) {
            //    //判断项目编号为空
            //    $.show_warning("提示", "项目编号为空");
            //    return false;
            //}
            return true;
        }

        //删除行
        function delet(index) {
            window.event? window.event.cancelBubble = true : e.stopPropagation();//阻止冒泡事件
            $('#dg').datagrid('deleteRow', index);
            var rows = $("#dg").datagrid('getRows');
            $("#dg").datagrid('loadData', rows);
            CalcFooter();//刷新footer
        }

        //批量导入弹层
        /*$("#win").dialog({
            title: '批量导入',
            width: 600,
            height: 400,

            buttons: [
                {
                    text: '下载模板',
                    iconCls: 'icon-save',
                    handler: function () {

                    }
                }, {
                    text: '确认导入',
                    iconCls: 'icon-ok',
                    handler: function () {
                        if (excelData.length > 0) {
                            for (var i = 0; i < excelData.length; i++) {
                                var rows = $('#dg').datagrid("getRows");
                                $("#dg").datagrid("insertRow", { index: rows.length, row: excelData[i] });
                            }
                            //$("#dg").datagrid('loadData', excelData);//execle导入插件数据回显datagrid
                            CalcFooter();//刷新footer
                            $("#win").dialog('close');//弹层关闭
                        } else {
                            alert("数据为空")
                        }
                    }
                }
            ]
        });*/

        //”批量导入”点击事件
        function batchImp() {
            $('<div/>').dialog({
                href: '/htm_ui/common/upFile.html',
                width: 600,
                height: 400,
                modal: true,
                title: '上传文件',
                iconCls: 'icon-file',
                buttons: [
                    {
                        text: '下载模板',
                        iconCls: 'icon-save',
                        handler: function () {
                            window.open("");
                        }
                    }, {
                        text: '确认导入',
                        iconCls: 'icon-ok',
                        handler: function () {
                            var d = $(this).closest('.window-body');
                            $("#formToUpdate").ajaxSubmit({
                                type: 'post',
                                enctype: 'multipart/form-data',
                                fileElementId: 'upFile',
                                url: '../ashx_ui/INVTA.ashx?action=import',
                                success: function (data1) {
                                    d.dialog('destroy');
                                    var data = JSON.parse(data1);
                                    //获取table最后一行序号
                                    var rows = $('#dg').datagrid("getRows");
                                    var lastId = 0;
                                    if (rows.length > 0) {
                                        lastId = $('#dg').datagrid('getData').rows[rows.length - 1].sortId;
                                    }
                                    if (data.rows.length > 0) {
                                        for (var i = 0; i < data.rows.length; i++) {
                                            var rows = $('#dg').datagrid("getRows");
                                            var sortIndex = parseInt(lastId) + i + 1;
                                            data.rows[i].sortId = PrefixInteger(sortIndex,4);
                                            $("#dg").datagrid("insertRow", { index: rows.length, row: data.rows[i] });
                                        }
                                        CalcFooter();//刷新footer
                                        $.show_warning("提示", "操作成功");
                                    } else {
                                        $.show_warning("提示", "数据为空");
                                    }

                                }
                            });
                        }
                    }
                ],
                onClose: function () {
                    $(this).dialog('destroy');
                }
            });
        }

        //点击“批量修改”
        function batchModify() {
            var comType = $('#modifyType').combobox('getValues')[0];
            var txt = $("#modifyTxt").val();
            var modifyPar = {};
            modifyPar[comType] = txt;
            var selData = $("#dg").datagrid("getSelections");
            if (selData.length > 0) {
                for (var i = 0; i < selData.length; i++) {
                    var index = $("#dg").datagrid('getRowIndex', selData[i]);
                    $("#dg").datagrid('updateRow', {
                        index: index,
                        row: modifyPar
                    });
                }
                CalcFooter();//刷新footer
            }

        }

        //combogrid中toobar查询按钮
        <a href="../../ashx_ui/renkuan.ashx">../../ashx_ui/renkuan.ashx</a>
        function toSearch() {



        }
        //单别
        $("#dbWin").dialog({
            title: '选择单别',
            width: 600,
            height: 400,
        });
        $("#dbWin").dialog('close');
        $("#batchTr").dialog('close');
        function orderTypeQty() {
            $("#dbWin").dialog('open');
        }
        //部门查询对话框
        function depmentQty() {
            $('<div id="dd"><div/>').dialog({
                href: '/htm_ui/common/dep.html',
                queryParams: { kk: '123' },
                width: 600,
                height: 350,
                modal: true,
                title: '部门查询',
                iconCls: 'icon-add',
                onClose: function () {
                    $(this).dialog('destroy');
                }
            });
        }

        //员工查询对话框
        function empQty() {
           $('<div id="aa"><div/>').dialog({
                href: '/htm_ui/common/emp.html',
                width: 600,
                height: 350,
                modal: true,
                title: '员工查询',
                iconCls: 'icon-add',
                onClose: function () {
                    $(this).dialog('destroy');
                }
            });
        }

        //判断是否为空
        function isEmpty(target) {
            if (target == null || target == "null" || target == "" || target == "undefined" || target == undefined) {
                return true;
            }
            return false;
        }
        //不足补零
        function PrefixInteger(num, length) {
            return (Array(length).join('0') + num).slice(-length);
        }
        $.extend($.fn.datagrid.defaults.editors, {

            combogrid: {

                init: function (container, options) {

                    var input = $('<inputtype="text" class="datagrid-editable-input">').appendTo(container);

                    input.combogrid(options);

                    return input;

                },

                destroy: function (target) {

                    $(target).combogrid('destroy');

                },

                getValue: function (target) {

                    return $(target).combogrid('getValue');

                },

                setValue: function (target, value) {

                    $(target).combogrid('setValue', value);

                },

                resize: function (target, width) {

                    $(target).combogrid('resize', width);

                },

            }

        });

        function focusNext(curRow) {
            //编辑状态下，键盘事件
            var editors = $("#dg").datagrid('getEditors', curRow);

            $(editors[0].target).parent().find(".combo-text").focus();//如果是combo需要加parent().find(".combo-text") 其他不用

            for (var i = 0, len = editors.length; i < len; i++) {
                //遍历编辑元素
                var editor = editors[i];
                var editorTarget = $(editor.target);
                if (editor.type == 'combogrid') {
                    editorTarget = $(editor.target).parent().find(".combo-text");
                }
                //下一个元素获取焦点
                var nextEditor;
                if (i + 1 < editors.length) {
                    if (editors[i + 1].type == 'combogrid') {
                        nextEditor = $(editors[i + 1].target).parent().find(".combo-text");
                    } else {
                        nextEditor = $(editors[i + 1].target);
                    }
                }
                //判断下一个元素为最后一个
                if ((i + 1) == editors.length) {
                    nextEditor = 'last';
                }

                editorTarget.bind('keyup', nextEditor, function (e) {
                    var code = e.keyCode || e.which;
                    if (code == 13) {
                        if (e.data != 'last') {
                            e.data.focus();
                        } else {
                            $("#dg").datagrid("endEdit", curRow);
                            addTr();
                        }

                    }
                });
            }
        }




    </script>
