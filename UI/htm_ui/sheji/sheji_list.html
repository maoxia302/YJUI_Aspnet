<link rel="stylesheet" type="text/css" href="../../css/default.css" />
<link rel="stylesheet" type="text/css" href="../../themes/default/easyui.css" />
<link rel="stylesheet" type="text/css" href="../../themes/icon.css" />
<script src="../../javascript/jquery-1.8.0.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../../javascript/jquery.easyui.min.js"></script>
<script src="../../locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
<script src="../../javascript/common_fn.js" type="text/javascript"></script>
<script src="../../javascript/WdatePicker.js" type="text/javascript"></script>
<script src="../../javascript/datagrid-detailview.js" type="text/javascript"></script>
<script src="../../javascript/jquery.form.min.js"></script>
<script type="text/javascript">
    var t = parent.$('#tabs').tabs('getSelected').panel('options').title;
    $(function () {
        /*var tabTool01 = '<a href="#" class="easyui-linkbutton"  data-options="iconCls:\''+ 'icon-search'+'\'" plain="true" onclick="batchImp();">导入</a>';
        var tabTool02 = '<a href="#" class="easyui-linkbutton 001" iconcls="icon-add" plain="true" onclick="add();">新增</a><a href="#" class="easyui-linkbutton 002" iconcls="icon-edit" plain="true" onclick="add_luoshijianhe();">上级检核</a>';
        var tabTool03 = '<a href="#" class="easyui-linkbutton 001" iconcls="icon-add" plain="true" onclick="add();">新增</a><a href="#" class="easyui-linkbutton 004" iconcls="icon-edit" plain="true" onclick="add_manyidupingjia();">满意评价</a>';
        var tabTool04 = '<a href="#" class="easyui-linkbutton 001" iconcls="icon-add" plain="true" onclick="add();">新增</a><a href="#" class="easyui-linkbutton 005" iconcls="icon-edit" plain="true" onclick="add_disanfang();">第三方检核</a>';
        if (t == '录入内容') {
            $('#barCont').append(tabTool01);
        } else if (t == '落实检查') {
            $('#barCont').append(tabTool02);
        } else if (t == '满意评价') {
            $('#barCont').append(tabTool03);

        } else if (t == '第三方检核') {
            $('#barCont').append(tabTool04);
        }*/

        var toobarArr = [
            /*{
                text: '导入',
                iconCls: 'icon-edit',
                handler: batchImp
            }, '-',
            {
                text: '添加内部台账',
                iconCls: 'icon-edit',
                handler: add_neibutaizhang
            }*/
        ];
        if (t == '录入内容') {
            toobarArr.push(
                {
                    text: '导入',
                    iconCls: 'icon-edit',
                    handler: batchImp
                }
            );
        } else if (t == '落实检查') {
            toobarArr.push(
                {
                    text: '新增',
                    iconCls: 'icon-add',
                    handler: add
                },
                {
                    text: '上级检核',
                    iconCls: 'icon-add',
                    handler: add_luoshijianhe
                }
            );
        } else if (t == '满意评价') {
            

        } else if (t == '第三方检核') {
            
        }


        $("#dg_sheji").datagrid({
            url: "/ashx_ui/shejitaizhang.ashx?action=search",
            idField: 'ID',
            striped: false, nowrap: false, autoRowHeight: false, rownumbers: false,
            showFooter: false, remoteSort: false, sortable: true, fit: true, singleSelect: true,
            pagination: true,
            pageSize: 30,
            pageList: [30, 40, 50],
            columns: [
                [
                    { field: "ID", title: "序号", width: 30 },
                    { field: "Pteam", title: "产品小组", width: 60 },
                    { field: "SubmitDate", title: "提报日期", width: 100 },
                    { field: "PreTime", title: "预计完成时间", width: 100 },
                    { field: "Item", title: "产品名称", width: 80 },
                    { field: "oem", title: "OEM", width: 80 },
                    { field: "Specification", title: "规格/适用车型", width: 50 },
                    { field: "Unit", title: "单位", width: 80 },
                    { field: "NewCategory", title: "新品类", width: 100 },
                    { field: "NewItem", title: "新品号", width: 100 },
                    { field: "Brand", title: "品牌", width: 60 },
                    { field: "Marking", title: "打标", width: 80 },
                    { field: "Markfactory", title: "打标信息厂家代码", width: 75 },
                    { field: "ItemLable", title: "产品标签", width: 60 },
                    { field: "Packing", title: "包装", width: 150 },
                    { field: "PackingType", title: "包装类型", width: 50 },
                    { field: "PackageSize", title: "包装尺寸", width: 150 },
                    { field: "PackageLabel", title: "包装标签", width: 80 },
                    { field: "Box", title: "物流箱", width: 150 },
                    { field: "BoxSize", title: "物流箱尺寸", width: 180 },
                    { field: "OuterLabel", title: "外箱标签", width: 100 },
                    { field: "Remark", title: "备注", width: 60 },
                    { field: "DesignerTime", title: "实际完成时间", width: 60 },
                    { field: "Designer", title: "产品组验收", width: 80 },
                    { field: "Accept", title: "产品组验收", width: 150 },
                    { field: "AcceptDate", title: "验收日期", width: 150 },
                    { field: "ManagerAccept", title: "事业部经理验收", width: 60 },
                    { field: "ManagerDate", title: "验收日期", width: 80 },
                    { field: "TimeOutDays", title: "超时天数", width: 80 },
                ]
            ],
            //toolbar: '#toolbar2'
            toolbar:toobarArr
        });
        quanxian();
    });
    function quanxian() {
        $("#a2").hide();
        var userid;
        getSession(function f(r) {
            var user = $.parseJSON(r);
            username = user.account;
            if (username == 'admin' || username == '李鹏') {
                $("#a2").show();
            }


        });
    }

    function yanqi(row, index) {
        var rows = $('#dg_sheji').datagrid('getRows');
        var fksj = rows[index].xxfksj; //获得反馈时间
        var clsj = rows[index].shclsj; //获得售后处理时间
        var fkdate = new Date(fksj.substr(0, 4), fksj.substr(4, 2) - 1, fksj.substr(6, 2));
        var cldate = new Date(clsj.substr(0, 4), clsj.substr(4, 2) - 1, clsj.substr(6, 2));
        var days = new Date(fkdate.getTime() - cldate.getTime()) / 24 / 60 / 60 / 1000;
        if (days >= 2) {
            return 'background-color:#ffee00;color:red;';
        }

    }
    function gongchang() {
        var r = $("#dg_sheji").datagrid("getChecked");
        if (r.length < 1) {
            $.show_warning("错误", "请选择一个要修改一个信息");
            return;
        }
        if (r.length > 1) {
            $.show_warning("错误", "一次只能修改一个信息");
            $("#dg_sheji").datagrid('clearSelections').datagrid('clearChecked');
            return;
        }
        //判断权限
        $("<div/>").dialog({
            href: "htm_ui/tuji/gongchang.htm",
            title: "工厂确认",
            height: 600,
            width: 600,
            modal: true,
            iconCls: "icon-add",
            buttons: [
                {
                    text: '确定添加',
                    iconCls: 'icon-add',
                    handler: function () {
                        var d = $(this).closest('.window-body');
                        $("#f_gongchang_add").form("submit", {
                            url: "../ashx_ui/TUJI.ashx",
                            onSubmit: function (param) {
                                param.action = 'gongchang';
                                param.ID = r[0].ID;
                                return $(this).form('validate');
                            },
                            success: function (result) {
                                dealAjaxResult(result, function (r) {
                                    d.dialog('destroy');
                                    $.show_warning("提示", "操作成功");
                                    $("#dg_sheji").datagrid('reload').datagrid('clearSelections').datagrid('clearChecked');
                                });
                            }
                        });
                    }
                },
                {
                    text: '取消添加',
                    iconCls: 'icon-cancel',
                    handler: function () { $(this).closest('.window-body').dialog('destroy'); }
                }
            ],
            onClose: function () {
                $(this).dialog('destroy');
            }, onLoad: function () {
                $("#tjxh").html(r[0].tjxh);
                $("#fdjh").html(r[0].fdjh);
                $("#jhbx").html(r[0].jhbx);
                $("#zjsj").html(r[0].zjsj);
                $("#gzfsdq").html(r[0].gzfsdq);
                $("#dls").html(r[0].dls);
                $("#xlc").html(r[0].xlc);
                $("#lxr").html(r[0].lxr);
                $("#xlctel").html(r[0].xlctel);
                $("#xxfkr").html(r[0].xxfkr);
                $("#xxfksj").html(r[0].xxfksj);
                $("#gzxx").html(r[0].gzxx);
                //（售后处理）
                $("#fenlei").html(r[0].fenlei);
                $("#gzms").html(r[0].gzms);
                $("#shclsj").html(r[0].shclsj);
                $("#zdfx").html(r[0].zdfx);
                $("#gznr").html(r[0].gznr);
                $("#zpje").html(r[0].zpje);
                $("#xxzrr").html(r[0].xxzrr);
                $("#shclyj").html(r[0].shclyj); //售后完成情况

                $("#thhfjg").html(r[0].thhfjg); //客户回访结果
                $("#dhqr").html(r[0].dhqr);
                $("#dhrq").html(r[0].dhrq);
                //拆检分析
                $("#cjrq").html(r[0].cjrq);
                $("#cjr").html(r[0].cjr);
                $("#cjfk").html(r[0].cjfk);
                $("#gzbw").html(r[0].gzbw);
                $("#zlpd").html(r[0].zlpd);
                //问题整改
                $("#gjzrr").html(r[0].gjzrr);
                $("#gjfa").html(r[0].gjfa);
                $("#gjrq").html(r[0].gjrq);
                $("#kcclcs").html(r[0].kcclcs);
                $("#kcwcrq").html(r[0].kcwcrq);
                $("#gysclcs").html(r[0].gysclcs);
                $("#gyswcrq").html(r[0].gyswcrq);
                $("#nblcgs").html(r[0].nblcgs);
                $("#nblcwcrq").html(r[0].nblcwcrq);
                $("#qtgjcs").html(r[0].qtgjcs);
                $("#qtwcrq").html(r[0].qtwcrq);
                $("#gjjs").html(r[0].gjjs);
                $("#f_gongchang_add").form("load", r[0]);
            }
        });
    }
    function add_tuji() {
        //判断权限
        $("<div/>").dialog({
            href: "htm_ui/tuji/tuji_add.htm",
            title: "添加凸机台账信息",
            height: 600,
            width: 600,
            modal: true,
            iconCls: "icon-add",
            buttons: [
                {
                    text: '确定添加',
                    iconCls: 'icon-add',
                    handler: function () {
                        var d = $(this).closest('.window-body');
                        $("#f_tuji_add").form("submit", {
                            url: "../ashx_ui/TUJI.ashx",
                            onSubmit: function (param) {
                                param.action = 'add_info';
                                return $(this).form('validate');
                            },
                            success: function (result) {
                                dealAjaxResult(result, function (r) {
                                    d.dialog('destroy');
                                    $.show_warning("提示", "操作成功");
                                    $("#dg_sheji").datagrid("reload");
                                });
                            }
                        });
                    }
                },
                {
                    text: '取消添加',
                    iconCls: 'icon-cancel',
                    handler: function () { $(this).closest('.window-body').dialog('destroy'); }
                }
            ],
            onClose: function () {
                $(this).dialog('destroy');
            },
            onLoad: function () {
                //加载经办人
                getSession(function f(r) {
                    var user = $.parseJSON(r);
                    $("#fkr").val(user.xingming);
                });

            }
        });
    }
    function xiangying() {
        var r = $("#dg_sheji").datagrid("getChecked");
        if (r.length < 1) {
            $.show_warning("错误", "请选择一个要修改一个信息");
            return;
        }
        if (r.length > 1) {
            $.show_warning("错误", "一次只能修改一个信息");
            $("#dg_sheji").datagrid('clearSelections').datagrid('clearChecked');
            return;
        }
        $("<div/>").dialog({
            href: "htm_ui/tuji/xiangying.htm",
            title: "售后相应处理",
            height: 600,
            width: 600,
            modal: true,
            iconCls: "icon-add",
            buttons: [
                {
                    text: '确定添加',
                    iconCls: 'icon-add',
                    handler: function () {
                        var d = $(this).closest('.window-body');
                        $("#f_xiangying_add").form("submit", {
                            url: "../ashx_ui/TUJI.ashx",
                            onSubmit: function (param) {
                                param.action = 'xiangying';
                                param.ID = r[0].ID;
                                return $(this).form('validate');
                            },
                            success: function (result) {
                                dealAjaxResult(result, function (r) {
                                    d.dialog('destroy');
                                    $.show_warning("提示", "操作成功");
                                    $("#dg_sheji").datagrid('reload').datagrid('clearSelections').datagrid('clearChecked');
                                });
                            }
                        });
                    }
                },
                {
                    text: '取消添加',
                    iconCls: 'icon-cancel',
                    handler: function () { $(this).closest('.window-body').dialog('destroy'); }
                }
            ],
            onClose: function () {
                $(this).dialog('destroy');
            },
            onLoad: function () {
                $("#tjxh").html(r[0].tjxh);
                $("#fdjh").html(r[0].fdjh);
                $("#jhbx").html(r[0].jhbx);
                $("#zjsj").html(r[0].zjsj);
                $("#gzfsdq").html(r[0].gzfsdq);
                $("#dls").html(r[0].dls);
                $("#xlc").html(r[0].xlc);
                $("#lxr").html(r[0].lxr);
                $("#xlctel").html(r[0].xlctel);
                $("#xxfkr").html(r[0].xxfkr);
                $("#xxfksj").html(r[0].xxfksj);
                $("#gzxx").html(r[0].gzxx);
                $('#cb_guzhangjian').combobox('setValue', r[0].zpje);
                $('#cb_guzhangjian').combobox('setText', r[0].zpje);
                $('#cb_gzfl').combobox('setValue', r[0].gzms);
                $('#cb_gzfl').combobox('setText', r[0].gzms);
                $("#f_xiangying_add").form("load", r[0]);
            }

        });
    }
    function huifang() {
        var r = $("#dg_sheji").datagrid("getChecked");
        if (r.length < 1) {
            $.show_warning("错误", "请选择一个要修改一个信息");
            return;
        }
        if (r.length > 1) {
            $.show_warning("错误", "一次只能修改一个信息");
            $("#dg_sheji").datagrid('clearSelections').datagrid('clearChecked');
            return;
        }
        $("<div/>").dialog({
            href: "htm_ui/tuji/huifang.htm",
            title: "回访结果填写",
            height: 600,
            width: 600,
            modal: true,
            iconCls: "icon-add",
            buttons: [
                {
                    text: '确定添加',
                    iconCls: 'icon-add',
                    handler: function () {
                        var d = $(this).closest('.window-body');
                        $("#f_huifang_add").form("submit", {
                            url: "../ashx_ui/TUJI.ashx",
                            onSubmit: function (param) {
                                param.action = 'huifang';
                                param.ID = r[0].ID;
                                return $(this).form('validate');
                            },
                            success: function (result) {
                                dealAjaxResult(result, function (r) {
                                    d.dialog('destroy');
                                    $.show_warning("提示", "操作成功");
                                    $("#dg_sheji").datagrid('reload').datagrid('clearSelections').datagrid('clearChecked');
                                });
                            }
                        });
                    }
                },
                {
                    text: '取消添加',
                    iconCls: 'icon-cancel',
                    handler: function () { $(this).closest('.window-body').dialog('destroy'); }
                }
            ],
            onClose: function () {
                $(this).dialog('destroy');
            },
            onLoad: function () {
                $("#tjxh").html(r[0].tjxh);
                $("#fdjh").html(r[0].fdjh);
                $("#jhbx").html(r[0].jhbx);
                $("#zjsj").html(r[0].zjsj);
                $("#gzfsdq").html(r[0].gzfsdq);
                $("#dls").html(r[0].dls);
                $("#xlc").html(r[0].xlc);
                $("#lxr").html(r[0].lxr);
                $("#xlctel").html(r[0].xlctel);
                $("#xxfkr").html(r[0].xxfkr);
                $("#xxfksj").html(r[0].xxfksj);
                $("#gzxx").html(r[0].gzxx);
                //（售后处理）

                $("#fenlei").html(r[0].fenlei);
                $("#gzms").html(r[0].gzms);
                $("#shclsj").html(r[0].shclsj);
                $("#zdfx").html(r[0].zdfx);
                $("#gznr").html(r[0].gznr);
                $("#zpje").html(r[0].zpje);
                $("#xxzrr").html(r[0].xxzrr);
                $("#shclyj").html(r[0].shclyj); //售后完成情况
                $("#f_huifang_add").form("load", r[0]);
            }
        });
    }
    //daohuo
    function fenku() {
        var r = $("#dg_sheji").datagrid("getChecked");
        if (r.length < 1) {
            $.show_warning("错误", "请选择一个要修改一个信息");
            return;
        }
        if (r.length > 1) {
            $.show_warning("错误", "一次只能修改一个信息");
            $("#dg_sheji").datagrid('clearSelections').datagrid('clearChecked');
            return;
        }
        $("<div/>").dialog({
            href: "htm_ui/tuji/daohuo.htm",
            title: "到货确认",
            height: 600,
            width: 600,
            modal: true,
            iconCls: "icon-add",
            buttons: [
                {
                    text: '确定添加',
                    iconCls: 'icon-add',
                    handler: function () {
                        var d = $(this).closest('.window-body');
                        $("#f_daohuo_add").form("submit", {
                            url: "../ashx_ui/TUJI.ashx",
                            onSubmit: function (param) {
                                param.action = 'fenku';
                                param.ID = r[0].ID;
                                return $(this).form('validate');
                            },
                            success: function (result) {
                                dealAjaxResult(result, function (r) {
                                    d.dialog('destroy');
                                    $.show_warning("提示", "操作成功");
                                    $("#dg_sheji").datagrid('reload').datagrid('clearSelections').datagrid('clearChecked');
                                });
                            }
                        });
                    }
                },
                {
                    text: '取消添加',
                    iconCls: 'icon-cancel',
                    handler: function () { $(this).closest('.window-body').dialog('destroy'); }
                }
            ],
            onClose: function () {
                $(this).dialog('destroy');
            },
            onLoad: function () {
                $("#f_daohuo_add").form("load", r[0]);
            }
        });
    }
    //”批量导入”点击事件
    function batchImp() {
        $('<div/>').dialog({
            href: '/htm_ui/common/upFile_sheji.html',
            width: 600,
            height: 400,
            modal: true,
            title: '上传文件',
            iconCls: 'icon-file',
            buttons: [
                {
                    text: '下载模板',
                    iconCls: 'icon-save',
                    handler: function () {
                        window.open("");
                    }
                }, {
                    text: '确认导入',
                    iconCls: 'icon-ok',
                    handler: function () {
                        var d = $(this).closest('.window-body');
                        $("#formToUpdate").ajaxSubmit({
                            type: 'post',
                            enctype: 'multipart/form-data',
                            fileElementId: 'upFile',
                            url: '/ashx_ui/shejitaizhang.ashx?action=import',
                            success: function (data) {
                               d.dialog('destroy');
                            }
                        });
                    }
                }
            ],
            onClose: function () {
                $(this).dialog('destroy');
            }
        });
    }



    function zongku() {
        var r = $("#dg_sheji").datagrid("getChecked");
        if (r.length < 1) {
            $.show_warning("错误", "请选择一个要修改一个信息");
            return;
        }
        if (r.length > 1) {
            $.show_warning("错误", "一次只能修改一个信息");
            $("#dg_sheji").datagrid('clearSelections').datagrid('clearChecked');
            return;
        }
        $("<div/>").dialog({
            href: "htm_ui/tuji/zkdaohuo.htm",
            title: "到货确认",
            height: 600,
            width: 600,
            modal: true,
            iconCls: "icon-add",
            buttons: [
                {
                    text: '确定添加',
                    iconCls: 'icon-add',
                    handler: function () {
                        var d = $(this).closest('.window-body');
                        $("#f_daohuo_add").form("submit", {
                            url: "../ashx_ui/TUJI.ashx",
                            onSubmit: function (param) {
                                param.action = 'zongku';
                                param.ID = r[0].ID;
                                return $(this).form('validate');
                            },
                            success: function (result) {
                                dealAjaxResult(result, function (r) {
                                    d.dialog('destroy');
                                    $.show_warning("提示", "操作成功");
                                    $("#dg_sheji").datagrid('reload').datagrid('clearSelections').datagrid('clearChecked');
                                });
                            }
                        });
                    }
                },
                {
                    text: '取消添加',
                    iconCls: 'icon-cancel',
                    handler: function () { $(this).closest('.window-body').dialog('destroy'); }
                }
            ],
            onClose: function () {
                $(this).dialog('destroy');
            },
            onLoad: function () {
                $("#f_daohuo_add").form("load", r[0]);
            }
        });
    }
    function chaijian() {
        var r = $("#dg_sheji").datagrid("getChecked");
        if (r.length < 1) {
            $.show_warning("错误", "请选择一个要修改一个信息");
            return;
        }
        if (r.length > 1) {
            $.show_warning("错误", "一次只能修改一个信息");
            $("#dg_sheji").datagrid('clearSelections').datagrid('clearChecked');
            return;
        }

        $("<div/>").dialog({
            href: "htm_ui/tuji/chaijian.htm",
            title: "旧机拆检分析",
            height: 600,
            width: 600,
            modal: true,
            iconCls: "icon-add",
            buttons: [
                {
                    text: '确定',
                    iconCls: 'icon-add',
                    handler: function () {
                        var d = $(this).closest('.window-body');

                        $("#f_chaijian_add").form("submit", {
                            url: "../ashx_ui/TUJI.ashx",
                            onSubmit: function (param) {

                                param.action = 'chaijian';
                                param.ID = r[0].ID;
                                return $(this).form('validate');
                            },
                            success: function (result) {
                                dealAjaxResult(result, function (r) {
                                    d.dialog('destroy');
                                    $.show_warning("提示", "操作成功");
                                    $("#dg_sheji").datagrid('reload').datagrid('clearSelections').datagrid('clearChecked');
                                });
                            }
                        });
                    }
                },
                {
                    text: '取消',
                    iconCls: 'icon-cancel',
                    handler: function () { $(this).closest('.window-body').dialog('destroy'); }
                }
            ],
            onClose: function () {
                $(this).dialog('destroy');
            },
            onLoad: function () {

                $("#f_chaijian_add").form("load", r[0]);

            }
        });
    }
    function Search() {
        $('#dg_sheji').datagrid('load', {//combobox获取value
            selectDate: $("#selectDate").combobox("getValue"),
            bdate: $('#bdate').val(),
            edate: $('#edate').val(),
            //chk: document.getElementById('chk').checked,
            txtWord: $('#txtWord').val()
        });
    }
    function toexcel() {
        var selectDate = $("#selectDate").combobox("getValue");
        var begindate = $('#bdate').val();
        var enddate = $('#edate').val();
        if (begindate == "" || enddate == "") {
            alert("请选择开始日期和结束日期");
        } else {
            window.open("../ashx_ui/export.ashx?action=export_tuji&selectDate=" + selectDate + "&begindate=" + begindate + "&enddate=" + enddate);
        }

    }
</script>
<div class="easyui-layout" data-options="fit : true,border : false">

    <div class="toolbar" id="toolbar2">
        <!--<div class="search-div">
            <label>关键字：</label>
            <input type="text" class="easyui-textbox" id="words" name="words" />
            <label>反馈时间：</label>
            <input type="text" class="Wdate" id="bdate" name="bdate" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})" />
            <input type="text" class="Wdate" id="edate" name="edate" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})">
            <a href="#" class="easyui-linkbutton" iconcls="icon-search" onclick="Search();">搜索</a>
        </div>-->
        <div class="ctrl-div">
            <div id="barCont"></div>
        </div>
    </div>
    <div data-options="region:'center',border:false">
        <table id="dg_sheji"></table>
    </div>

</div>

